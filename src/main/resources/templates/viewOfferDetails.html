<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>    
    <title>E-Cycle - Offer Details</title>
    <link rel="icon" th:href="@{/images/logos/logoIcon.png}" type="image/png">
    <link rel="stylesheet" th:href="@{/css/viewOfferDetails.css}">
</head>
<body>
    <header>
        <div>
            <img th:src="@{/images/logos/logo.png}" alt="E-Cycle Logo">
            <h1>Offer Details</h1>
        </div>
        <div>
            <a href="/home">Back to Home</a>
        </div>
    </header>
    <main>
        <section class="offer-details">
            <h2 th:text="${offer.title}">Offer Title</h2>
            
            <!-- Active Offers Section -->
            <h3 class="section-title">Active Offers</h3>
            
            <!-- Error message container for displaying in-page errors -->            <div id="error-message-container" class="error-message" style="display: none;">
                <p id="error-message-text"></p>
            </div>
            
            <div th:if="${singOffers.isEmpty()}">
                <p>No active items available in this offer</p>
            </div>
            
            <div th:if="${!singOffers.isEmpty()}">
                <table id="singOffersTable">
                    <thead>
                        <tr>
                            <th class="checkbox-column">Select</th>
                            <th>Category</th>
                            <th>Nature</th>
                            <th>Brand</th>
                            <th>Model</th>
                            <th>Batch</th>
                            <th>Quality</th>
                            <th>Function</th>
                            <th>Main Color</th>
                            <th>Description</th>
                            <th>Price</th>
                            <th>Expiration</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>                        
                        <tr th:each="singOffer, iterStat : ${singOffers}">
                            <td class="checkbox-column">
                                <input type="radio" name="selectedOffer" th:value="${singOffer.id}" th:id="'offer-' + ${singOffer.id}">
                            </td>
                            <td th:text="${singOffer.characteristics?.category?.id}"></td>
                            <td th:text="${singOffer.characteristics?.nature?.id}"></td>
                            <td th:text="${singOffer.characteristics?.model?.brand?.id}"></td>
                            <td th:text="${singOffer.characteristics?.model?.id}"></td>
                            <td th:text="${singOffer.characteristics?.batch}"></td>
                            <td th:text="${singOffer.characteristics?.quality}"></td>
                            <td th:text="${singOffer.characteristics?.function}"></td>
                            <td th:text="${singOffer.characteristics?.mainColour}"></td>
                            <td th:text="${singOffer.description}"></td>
                            <td th:text="${singOffer.price}"></td>
                            <td th:text="${singOffer.expiration}"></td>
                            <td th:text="${statuses != null && !statuses.isEmpty() && iterStat.index < statuses.size() ? statuses[iterStat.index] : ''}"></td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="actions">
                    <button id="deleteButton">Delete Selected Item</button>
                </div>
            </div>
              <!-- Revenue Summary Section -->
            <h3 class="section-title">Revenue Summary</h3>
            <div class="revenue-summary">
                <p><strong>Total Revenue from Accepted Offers:</strong> <span th:text="${revenue != null ? '$' + #numbers.formatDecimal(revenue, 1, 2) : '$0.00'}">$0.00</span></p>
                <p><em>This total includes all offers with "Accepted" status</em></p>
            </div>
            
            <!-- Inactive Offers Section -->
            <h3 class="section-title">Inactive Offers</h3>
            <div th:if="${inactiveSingOffers.isEmpty()}">
                <p>No inactive items available in this offer</p>
            </div>
            <div th:if="${!inactiveSingOffers.isEmpty()}">
                <table id="inactiveSingOffersTable" class="inactive-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Nature</th>
                            <th>Brand</th>
                            <th>Model</th>
                            <th>Batch</th>
                            <th>Quality</th>
                            <th>Function</th>
                            <th>Main Color</th>
                            <th>Description</th>
                            <th>Price</th>
                            <th>Expiration</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>                        
                        <tr th:each="singOffer, iterStat : ${inactiveSingOffers}">
                            <td th:text="${singOffer.characteristics?.category?.id}"></td>
                            <td th:text="${singOffer.characteristics?.nature?.id}"></td>
                            <td th:text="${singOffer.characteristics?.model?.brand?.id}"></td>
                            <td th:text="${singOffer.characteristics?.model?.id}"></td>
                            <td th:text="${singOffer.characteristics?.batch}"></td>
                            <td th:text="${singOffer.characteristics?.quality}"></td>
                            <td th:text="${singOffer.characteristics?.function}"></td>
                            <td th:text="${singOffer.characteristics?.mainColour}"></td>
                            <td th:text="${singOffer.description}"></td>
                            <td th:text="${singOffer.price}"></td>
                            <td th:text="${singOffer.expiration}"></td>
                            <td th:text="${inactiveStatuses != null && !inactiveStatuses.isEmpty() && iterStat.index < inactiveStatuses.size() ? inactiveStatuses[iterStat.index] : ''}"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>
      <script>
        // Function to show error message in page instead of alert
        function showError(message) {
            const errorContainer = document.getElementById('error-message-container');
            const errorText = document.getElementById('error-message-text');
            errorText.textContent = message;
            errorContainer.style.display = 'block';
            // Scroll to error message
            errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Hide the message after 5 seconds
            setTimeout(() => {
                errorContainer.style.display = 'none';
            }, 5000);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Sort active table when clicking on headers
            document.querySelectorAll('#singOffersTable th').forEach((header, index) => {
                if (!header.classList.contains('checkbox-column')) {
                    header.addEventListener('click', function() {
                        sortTable(this, 'singOffersTable');
                    });
                }
            });

            // Sort inactive table when clicking on headers
            document.querySelectorAll('#inactiveSingOffersTable th').forEach(header => {
                header.addEventListener('click', function() {
                    sortTable(this, 'inactiveSingOffersTable');
                });
            });
            
            // Auto-sort tables on page load (starting with category column)
            const sortActiveTableHeader = document.querySelector('#singOffersTable th:nth-child(2)'); // Category column
            if (sortActiveTableHeader) {
                sortTable(sortActiveTableHeader, 'singOffersTable');
            }
            
            const sortInactiveTableHeader = document.querySelector('#inactiveSingOffersTable th:first-child'); // Category column
            if (sortInactiveTableHeader) {
                sortTable(sortInactiveTableHeader, 'inactiveSingOffersTable');
            }
            // Handle delete button click with double-click confirmation
            const deleteButton = document.getElementById('deleteButton');
            let isConfirmMode = false;
            
            deleteButton.addEventListener('click', function() {
                const selectedOffer = document.querySelector('input[name="selectedOffer"]:checked');
                  if (!selectedOffer) {
                    showError('Please select an item to delete');
                    return;
                }
                
                if (!isConfirmMode) {
                    // First click - change to confirm mode
                    deleteButton.textContent = "Click to Confirm";
                    isConfirmMode = true;
                    
                    // Reset confirm mode after 3 seconds if not clicked
                    setTimeout(() => {
                        if (isConfirmMode) {
                            deleteButton.textContent = "Delete Selected Item";
                            isConfirmMode = false;
                        }
                    }, 3000);
                    
                    return;
                }
                
                // Second click - proceed with deletion
                fetch('/deleteSingOffer?singOfferId=' + selectedOffer.value, {
                    method: 'PUT'
                })                .then(response => {
                    if (response.ok || response.redirected) {
                        window.location.href = '/home?singOfferDeleted=true';
                    } else {
                        showError('Failed to delete the item. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError('An error occurred while deleting the item.');
                });
                
                // Reset button
                deleteButton.textContent = "Delete Selected Item";
                isConfirmMode = false;
            });
        });
          // Table sorting function
        function sortTable(header, tableId) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
              const columnIndex = Array.from(header.parentNode.children).indexOf(header);
            
            // Check if the column contains timestamp data (do not use for sorting as requested)
            const isTimestamp = ['Date', 'Created', 'Updated', 'Time'].some(term => 
                header.textContent.includes(term));
                
            if (isTimestamp) {
                // Add a comment to indicate timestamps are not considered for sorting
                console.log('Timestamp columns are not considered for sorting as requested');
                return; // Skip sorting for timestamp columns
            }
            
            // Only consider Price as numeric for sorting
            const isNumeric = ['Price'].includes(header.textContent);
            // Determine sort direction
            const sortDirection = header.getAttribute('data-sort') === 'asc' ? 'desc' : 'asc';
            
            // Clear previous sort directions
            table.querySelectorAll('th').forEach(th => {
                th.removeAttribute('data-sort');
            });
            
            // Set current sort direction
            header.setAttribute('data-sort', sortDirection);
            
            // Sort rows
            rows.sort((a, b) => {
                let aValue = a.children[columnIndex].textContent.trim();
                let bValue = b.children[columnIndex].textContent.trim();
                
                if (isNumeric) {
                    aValue = parseFloat(aValue) || 0;
                    bValue = parseFloat(bValue) || 0;
                }
                
                if (aValue < bValue) return sortDirection === 'asc' ? -1 : 1;
                if (aValue > bValue) return sortDirection === 'asc' ? 1 : -1;
                
                // If values are equal, sort by next columns (left to right)
                if (aValue === bValue) {
                    const columns = header.parentNode.children.length;
                    for (let nextCol = columnIndex + 1; nextCol < columns; nextCol++) {
                        // Skip checkbox column if present
                        if (header.parentNode.children[nextCol].classList.contains('checkbox-column')) {
                            continue;
                        }
                        
                        aValue = a.children[nextCol].textContent.trim();
                        bValue = b.children[nextCol].textContent.trim();
                        
                        // Only consider Price as numeric, not timestamps (as requested)
                        const isNextColNumeric = ['Price'].includes(
                            header.parentNode.children[nextCol].textContent);
                        
                        if (isNextColNumeric) {
                            aValue = parseFloat(aValue) || 0;
                            bValue = parseFloat(bValue) || 0;
                        }
                        
                        if (aValue < bValue) return sortDirection === 'asc' ? -1 : 1;
                        if (aValue > bValue) return sortDirection === 'asc' ? 1 : -1;
                    }
                }
                
                return 0;
            });
            
            // Re-append rows in the new order
            rows.forEach(row => tbody.appendChild(row));
        }
    </script>
</body>
</html>
