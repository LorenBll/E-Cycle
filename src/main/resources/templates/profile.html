<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>    
    <title>E-Cycle - Profile</title>    
    <link rel="icon" th:href="@{/images/logos/logoIcon.png}" type="image/png">
    <link rel="stylesheet" href="/css/profile.css">
    <!-- Styling removed as requested -->
</head>
<body>
    <div class="profile-container">
        <!-- Logo background centrale -->
        <img src="/images/logos/logo.png" alt="E-Cycle Logo" class="profile-bg-logo">
        <!-- Header con pulsante Home -->
        <div class="profile-header">
            <button type="button" class="profile-home-btn" onclick="window.location.href='/home'">Home</button>
        </div>
        <main class="profile-main">
            <div class="profile-left">
                <div class="profile-title">User Profile</div>
                <div class="profile-box">
                    <div class="profile-box-title">Account Information</div>
                    <div class="profile-box-content">
                        <!-- Inserisci qui i dati account, es: username, email, nome, cognome -->
                        <div><strong>Username:</strong> <span th:text="${user.username}"></span></div>
                        <div><strong>Email:</strong> <span th:text="${user.email}"></span></div>
                        <div><strong>Name:</strong> <span th:text="${user.name}"></span></div>
                        <div><strong>Surname:</strong> <span th:text="${user.surname}"></span></div>
                    </div>
                </div>
                <div class="profile-box">
                    <div class="profile-box-title">Address</div>
                    <div class="profile-box-content">
                        <!-- Inserisci qui i dati indirizzo -->
                        <div><strong>State:</strong> <span th:text="${user.state}"></span></div>
                        <div><strong>Region:</strong> <span th:text="${user.region}"></span></div>
                        <div><strong>Province:</strong> <span th:text="${user.province}"></span></div>
                        <div><strong>City:</strong> <span th:text="${user.city}"></span></div>
                        <div><strong>Street:</strong> <span th:text="${user.street}"></span></div>
                        <div><strong>Civic Number:</strong> <span th:text="${user.civic}"></span></div>
                    </div>
                </div>
            </div>
            <button type="button" class="profile-edit-btn">Edit Profile</button>
        </main>
    </div>        
    <script>        
        // Function to show error message in page instead of alert
        function showError(message) {
            const errorContainer = document.getElementById('error-message-container');
            const errorText = document.getElementById('error-message-text');
            errorText.textContent = message;
            errorContainer.style.display = 'block';
            // Scroll to error message
            errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Hide the message after 5 seconds
            setTimeout(() => {
                errorContainer.style.display = 'none';
            }, 5000);
        }
        
        function deleteAccount() {
            const deleteBtn = document.getElementById('delete-account-btn');
            
            if (deleteBtn.textContent === "Delete My Account") {
                // First click - change button text to confirmation message
                deleteBtn.textContent = "Click to confirm";
            } else {
                // Second click - actually delete the account
                fetch('/profile/delete', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        // Include CSRF token if your Spring Security setup requires it
                        // 'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').getAttribute('content')
                    }
                }).then(response => {
                    if (response.redirected) {
                        window.location.href = response.url;
                    } else {
                        window.location.href = "/login?deleted=true";
                    }                }).catch(error => {
                    console.error('Error:', error);
                    showError('An error occurred while trying to delete your account. Please try again later.');
                });
            }
        }
        
        function togglePassword(inputId, openEyeId, closedEyeId) {
            const passwordInput = document.getElementById(inputId);
            const openEye = document.getElementById(openEyeId);
            const closedEye = document.getElementById(closedEyeId);
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                openEye.style.display = 'none';
                closedEye.style.display = 'inline';
            } else {
                passwordInput.type = 'password';
                openEye.style.display = 'inline';
                closedEye.style.display = 'none';
            }
        }        
        
        function checkPasswordStrength() {
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('dynamic-error-message');
            const errorMessage = document.getElementById('error-message-text');
            
            if (password.length === 0) {
                errorDiv.style.display = 'none';
                return;
            }
            
            if (password.length < 8) {
                errorDiv.style.display = 'block';
                errorMessage.textContent = 'Password must be at least 8 characters long.';
                return;
            }
            
            if (!/[A-Z]/.test(password)) {
                errorDiv.style.display = 'block';
                errorMessage.textContent = 'Password must contain at least one uppercase letter.';
                return;
            }
            
            if (!/[a-z]/.test(password)) {
                errorDiv.style.display = 'block';
                errorMessage.textContent = 'Password must contain at least one lowercase letter.';
                return;
            }

            
            if (!/[^A-Za-z0-9]/.test(password)) {
                errorDiv.style.display = 'block';
                errorMessage.textContent = 'Password must contain at least one special character.';
                return;
            }
            
            errorDiv.style.display = 'none';
        }

        function checkPasswordsMatch() {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            const errorDiv = document.getElementById('dynamic-error-message');
            const errorMessage = document.getElementById('error-message-text');
            
            if (confirmPassword.length === 0) {
                return;
            }
            
            if (password !== confirmPassword) {
                errorDiv.style.display = 'block';
                errorMessage.textContent = 'Passwords do not match.';
            } else {
                // Only hide the error if it's currently showing a password match error
                if (errorMessage.textContent === 'Passwords do not match.') {
                    errorDiv.style.display = 'none';
                }
            }
        }
        
        function validatePassword(password) {
            const errorDiv = document.getElementById('dynamic-error-message');
            const errorMessage = document.getElementById('error-message-text');
            
            // Check password length
            if (password.length < 8) {
                errorDiv.style.display = 'block';
                errorMessage.textContent = 'Password must be at least 8 characters long.';
                return false;
            }
            
            // Check for uppercase letter
            if (!/[A-Z]/.test(password)) {
                errorDiv.style.display = 'block';
                errorMessage.textContent = 'Password must contain at least one uppercase letter.';
                return false;
            }
            
            // Check for special character
            if (!/[^A-Za-z0-9]/.test(password)) {
                errorDiv.style.display = 'block';
                errorMessage.textContent = 'Password must contain at least one special character.';
                return false;
            }
            
            return true;
        }        
        
        document.addEventListener('DOMContentLoaded', function() {
            const editProfileForm = document.getElementById('edit-profile-form');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const successMessage = document.querySelector('.success-message');
            const deleteAccountBtn = document.getElementById('delete-account-btn');
            
            // Add event listener for delete account button
            if (deleteAccountBtn) {
                deleteAccountBtn.addEventListener('click', deleteAccount);
            }
            
            // Password visibility toggle functionality is now handled by the togglePassword function
            // Add event listeners once the DOM is fully loaded
            const passwordInput = document.getElementById('password');
            const confirmPasswordInput = document.getElementById('confirm_password');
            
            // Check password requirements as user types
            passwordInput.addEventListener('input', checkPasswordStrength);
            
            // Check if passwords match when user types in either field
            passwordInput.addEventListener('input', checkPasswordsMatch);
            confirmPasswordInput.addEventListener('input', checkPasswordsMatch);
              // Form validation with password confirmation
            const form = document.getElementById('profileEditForm');
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirm_password').value;
                const username = document.getElementById('username').value;
                const email = document.getElementById('email').value;
                const errorDiv = document.getElementById('dynamic-error-message');
                const errorMessage = document.getElementById('error-message-text');
                
                // Check for empty username
                if (!username.trim()) {
                    errorDiv.style.display = 'block';
                    errorMessage.textContent = 'Username cannot be empty!';
                    return;
                }
                
                // Check username length
                if (username.length > 50) {
                    errorDiv.style.display = 'block';
                    errorMessage.textContent = 'Username cannot exceed 50 characters!';
                    return;
                }
                
                // Check email validity
                if (!email.trim() || !email.includes('@')) {
                    errorDiv.style.display = 'block';
                    errorMessage.textContent = 'Please enter a valid email address!';
                    return;
                }
                
                // Check email length
                if (email.length > 100) {
                    errorDiv.style.display = 'block';
                    errorMessage.textContent = 'Email cannot exceed 100 characters!';
                    return;
                }
                
                // Check other field lengths
                const name = document.getElementById('name').value;
                if (name.length > 50) {
                    errorDiv.style.display = 'block';
                    errorMessage.textContent = 'Name cannot exceed 50 characters!';
                    return;
                }
                
                const surname = document.getElementById('surname').value;
                if (surname.length > 50) {
                    errorDiv.style.display = 'block';
                    errorMessage.textContent = 'Surname cannot exceed 50 characters!';
                    return;
                }
                
                const state = document.getElementById('state').value;
                if (state.length > 50) {
                    errorDiv.style.display = 'block';
                    errorMessage.textContent = 'State cannot exceed 50 characters!';
                    return;
                }
                
                const region = document.getElementById('region').value;
                if (region.length > 50) {
                    errorDiv.style.display = 'block';
                    errorMessage.textContent = 'Region cannot exceed 50 characters!';
                    return;
                }
                
                const province = document.getElementById('province').value;
                if (province.length > 50) {
                    errorDiv.style.display = 'block';
                    errorMessage.textContent = 'Province cannot exceed 50 characters!';
                    return;
                }
                
                const city = document.getElementById('city').value;
                if (city.length > 50) {
                    errorDiv.style.display = 'block';
                    errorMessage.textContent = 'City cannot exceed 50 characters!';
                    return;
                }
                
                const street = document.getElementById('street').value;
                if (street.length > 100) {
                    errorDiv.style.display = 'block';
                    errorMessage.textContent = 'Street cannot exceed 100 characters!';
                    return;
                }
                
                const civic = document.getElementById('civic').value;
                if (civic.length > 50) {
                    errorDiv.style.display = 'block';
                    errorMessage.textContent = 'Civic Number cannot exceed 50 characters!';
                    return;
                }
                
                // Only validate passwords if user is trying to change password
                if (password || confirmPassword) {
                    if (password !== confirmPassword) {
                        errorDiv.style.display = 'block';
                        errorMessage.textContent = 'Passwords do not match!';
                        return;
                    }
                    
                    // Password validation rules
                    if (password) {
                        if (!validatePassword(password)) {
                            return;
                        }
                    }
                }
                
                // Create JSON data from form inputs
                const formData = {
                    username: document.getElementById('username').value,
                    name: document.getElementById('name').value,
                    surname: document.getElementById('surname').value,
                    email: document.getElementById('email').value,
                    password: document.getElementById('password').value,
                    state: document.getElementById('state').value,
                    region: document.getElementById('region').value,
                    province: document.getElementById('province').value,
                    city: document.getElementById('city').value,
                    street: document.getElementById('street').value,
                    civic: document.getElementById('civic').value
                };
                
                // Submit form data as JSON
                fetch('/profile/edit', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    if (response.redirected) {
                        window.location.href = response.url;
                    } else if (response.ok) {
                        window.location.href = '/profile';
                    } else {
                        console.error('Profile update failed');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });
        
    </script>
</body>
</html>
